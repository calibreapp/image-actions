# Image Actions

Image Actions automatically compresses JPEG, PNG and WebP images in GitHub Pull Requests.

- **Fast, efficient and near-lossless compression**
- Uses the best image compression algorithms available: [mozjpeg](https://github.com/mozilla/mozjpeg) and [libvips](https://github.com/libvips/libvips)
- [Configurable](#Configuration) and extensible: use default settings or adapt to your needs
- Runs in [GitHub Actions](https://github.com/features/actions)
- Built by web performance experts at [Calibre](https://calibreapp.com/); a performance monitoring platform

![Preview of image-actions Pull Request comment](https://user-images.githubusercontent.com/924/62024579-e1470d00-b218-11e9-8655-693ea42ba0f7.png)

### Table of Contents

- [Installation](#Installation)
- [Configuration](#Configuration)
  - [Image quality settings](#Image-quality-settings)
  - [Run only when images files are added or changed](#Run-only-when-images-files-are-added-or-changed)
- [Links and Resources](#Links-and-Resources)

## Installation

1. Open or create the `.github/workflows/calibreapp-image-actions.yml` file.
2. Paste in the following:

```yml
name: Compress images
on: pull_request
jobs:
  build:
    name: calibreapp/image-actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@master

      - name: Compress Images
        uses: calibreapp/image-actions@master
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
```

The `GITHUB_TOKEN` secret is [automatically generated by GitHub](https://help.github.com/en/articles/virtual-environments-for-github-actions#github_token-secret). This automatic token is [scoped only to the repository that is currently running the action.](https://help.github.com/en/articles/virtual-environments-for-github-actions#token-permissions)

## Configuration

By default image actions will compress your images so that they’re smaller, using compression that will leave your assets looking good. If you want to change those defaults, read on.

Previous versions of image-actions used `.github/config/image-actions.yml` for configuration. If you're still using that configuration method we suggest that you update it.

## Image quality settings

However, if you’d like to ignore specific file paths, or change image compression options, read on.

Change the configuration options by adding arguments to the action workflow definition:

```yml
- name: Compress Images
  uses: calibreapp/image-actions@master
  with:
    githubToken: ${{ secrets.GITHUB_TOKEN }}
    jpegQuality: "80"
    pngQuality: "80"
    webpQuality: "80"
    ignorePaths: "node_modules/**,build"
    # No spaces allowed
```

- The above configuration is what `image-actions` uses by default
- The `jpegQuality`, `pngQuality` and `webpQuality` config keys will be delivered directly into [sharp’s](http://sharp.pixelplumbing.com) `toFormat`. ([JPEG options](http://sharp.pixelplumbing.com/en/stable/api-output/#jpeg), [PNG options](http://sharp.pixelplumbing.com/en/stable/api-output/#png), [Webp options](http://sharp.pixelplumbing.com/en/stable/api-output/#webp))
- `ignorePaths` - a comma separated list of paths. allows for path globbing ([see the glob package for more details](https://www.npmjs.com/package/glob))

## Run only when images files are added or changed

`image-actions` is designed to run for each Pull Request. In some repositories, images are seldom updated. To run the action only when images have changed, use GitHub Action’s [`on.push.paths`](https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions#onpushpull_requestpaths) workflow configuration:

```yml
name: Compress images
on:
  pull_request:
    paths:
      - "**.jpg"
      - "**.png"
      - "**.webp"
jobs:
  build:
    name: calibreapp/image-actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@master

      - name: Compress Images
        uses: calibreapp/image-actions@master
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
```

The above workflow will only run when `jpg`, `png` or `webp` files are changed.

## Links and Resources

- **[Announcement post: Automatically compress images on Pull Requests](https://calibreapp.com/blog/compress-images-in-prs/)**
- [Image Actions on GitHub Marketplace](https://github.com/marketplace/actions/image-actions)
- [sharp](https://github.com/lovell/sharp)
- [mozjpeg](https://github.com/mozilla/mozjpeg)
- [libvips](https://github.com/libvips/libvips)
- [Learn more about GitHub Actions](https://github.com/features/actions)
- [Start monitoring your sites performance](https://calibreapp.com/)
